<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>Jira Ticket Search - Test Generation System</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="row mb-4">
            <div class="col">
                <h2>Jira Ticket Search</h2>
                <p class="text-muted">Search tickets from your Jira server using JQL</p>
            </div>
            <div class="col text-end">
                <a th:href="@{/jira/connections}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to connections
                </a>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <div th:if="${error}" class="alert alert-danger mb-4" role="alert">
                    <h5 class="alert-heading">Error during search</h5>
                    <p th:text="${error}"></p>
                    <hr>
                    <p class="mb-0 small">
                        Suggestions:
                        <ul>
                            <li>Verify that the project code is correct</li>
                            <li>Check the JQL query syntax</li>
                            <li>Make sure you have permissions to access the tickets</li>
                        </ul>
                    </p>
                </div>
                
                <form th:action="@{/jira/search}" method="post">
                    <input type="hidden" name="connectionId" th:value="${connectionId}"/>
                    
                    <div class="mb-3">
                        <label for="jql" class="form-label">JQL Query</label>
                        <input type="text" class="form-control" id="jql" name="jql" required
                               th:value="${jql ?: ''}"
                               placeholder="project = PROJ AND status = 'In Progress'"/>
                        <div class="form-text">Enter a valid JQL query to search for tickets.</div>
                    </div>
                    
                    <div class="mb-3">
                        <button type="submit" class="btn btn-primary">Search</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Available Projects</h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${projects == null || projects.isEmpty()}" class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> No available projects. Check your Jira connection.
                        </div>
                        <div th:if="${!projects.isEmpty()}" class="list-group">
                            <button th:each="project : ${projects}" 
                                    type="button" 
                                    class="list-group-item list-group-item-action project-select-item"
                                    th:attr="data-key=${project.key}" 
                                    th:text="${project.name + ' (' + project.key + ')'}">
                                Project name
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Ready-to-Use JQL Queries</h5>
                        <span id="selected-project-badge" class="badge bg-primary d-none">No project selected</span>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle"></i> Select a project from the list on the left to generate custom JQL queries.
                        </div>
                        
                        <div class="list-group">
                            <button type="button" class="list-group-item list-group-item-action jql-query-item" data-query-template="project = {PROJECT_KEY}">All project tickets</button>
                            <button type="button" class="list-group-item list-group-item-action jql-query-item" data-query-template="project = {PROJECT_KEY} AND status = 'In Progress'">Tickets in progress</button>
                            <button type="button" class="list-group-item list-group-item-action jql-query-item" data-query-template="project = {PROJECT_KEY} AND created >= -7d">Tickets from the last 7 days</button>
                            <button type="button" class="list-group-item list-group-item-action jql-query-item" data-query-template="project = {PROJECT_KEY} AND fixVersion = latestReleasedVersion()">Tickets in the latest released version</button>
                            <button type="button" class="list-group-item list-group-item-action jql-query-item" data-query-template="project = {PROJECT_KEY} AND priority = High ORDER BY created DESC">High priority tickets, most recent first</button>
                            <button type="button" class="list-group-item list-group-item-action jql-query-item" data-query-template="assignee = currentUser() AND resolution = unresolved">My unresolved tickets</button>
                            <button type="button" class="list-group-item list-group-item-action jql-query-item" data-query-template="project = {PROJECT_KEY} AND labels = 'test-automation'">Tickets with test-automation label</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Advanced JQL Queries</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    <button type="button" class="list-group-item list-group-item-action jql-query-item" data-query-template="project = {PROJECT_KEY} AND type = Bug AND status changed FROM 'In Progress' TO 'Done' DURING (startOfWeek(), endOfWeek())">Bugs completed this week</button>
                    <button type="button" class="list-group-item list-group-item-action jql-query-item" data-query-template="project in ({PROJECT_KEY}) AND sprint in openSprints()">Tickets in open sprints</button>
                    <button type="button" class="list-group-item list-group-item-action jql-query-item" data-query-template="project = {PROJECT_KEY} AND text ~ 'test automation'">Tickets with text "test automation"</button>
                    <button type="button" class="list-group-item list-group-item-action jql-query-item" data-query-template="project = {PROJECT_KEY} AND issueFunction in linkedIssuesOf('key = {PROJECT_KEY}-123')">Tickets linked to a specific ticket</button>
                    <button type="button" class="list-group-item list-group-item-action jql-query-item" data-query-template="project = {PROJECT_KEY} AND (status changed TO 'In Progress' BY currentUser() OR assignee = currentUser())">Tickets assigned to me or moved to in progress by me</button>
                    <button type="button" class="list-group-item list-group-item-action jql-query-item" data-query-template="project = {PROJECT_KEY} AND (type = Bug OR type = 'Test Case') AND component = 'UI'">Bugs or Test Case in the UI component</button>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Jira REST API Endpoints for Developers</h5>
            </div>
            <div class="card-body">
                <p>If you need to integrate Jira into your code, here are the main endpoints for ticket search:</p>
                
                <h6 class="mt-3">GET Search (for simple queries):</h6>
                <pre class="bg-light p-3"><code>GET /rest/api/2/search?jql=project=QA&fields=id,key</code></pre>
                
                <h6 class="mt-3">POST Search (for complex queries):</h6>
                <pre class="bg-light p-3"><code>POST /rest/api/2/search
Content-Type: application/json

{
  "jql": "project = QA",
  "startAt": 0,
  "maxResults": 10,
  "fields": ["id", "key", "summary", "status"]
}</code></pre>
                
                <p class="mt-3">
                    <a href="https://developer.atlassian.com/server/jira/platform/jira-rest-api-examples/" target="_blank" class="btn btn-sm btn-outline-info">
                        <i class="bi bi-box-arrow-up-right"></i> Official documentation
                    </a>
                </p>
            </div>
        </div>
    </div>

    <th:block layout:fragment="extra-js">
        <script th:src="@{/js/jira-integration.js}"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const queryItems = document.querySelectorAll('.jql-query-item');
                const projectItems = document.querySelectorAll('.project-select-item');
                const jqlInput = document.getElementById('jql');
                const projectBadge = document.getElementById('selected-project-badge');
                
                let selectedProjectKey = '';
                
                // Gestione della selezione del progetto
                projectItems.forEach(item => {
                    item.addEventListener('click', function() {
                        // Rimuove la classe attiva da tutti gli elementi
                        projectItems.forEach(p => p.classList.remove('active'));
                        
                        // Aggiunge la classe attiva all'elemento corrente
                        this.classList.add('active');
                        
                        // Memorizza il codice del progetto selezionato
                        selectedProjectKey = this.getAttribute('data-key');
                        
                        // Aggiorna il badge con il progetto selezionato
                        projectBadge.textContent = 'Project: ' + selectedProjectKey;
                        projectBadge.classList.remove('d-none');
                    });
                });
                
                // Gestione del click sulle query precompilate
                queryItems.forEach(item => {
                    item.addEventListener('click', function() {
                        let queryTemplate = this.getAttribute('data-query-template');
                        let query = queryTemplate;
                        
                        // Se c'è un placeholder per il progetto, lo sostituisce con il progetto selezionato
                        if (queryTemplate.includes('{PROJECT_KEY}')) {
                            if (selectedProjectKey) {
                                query = queryTemplate.replace(/\{PROJECT_KEY\}/g, selectedProjectKey);
                            } else {
                                // Se nessun progetto è stato selezionato, mostra un avviso
                                alert('Select a project from the list on the left first');
                                return;
                            }
                        }
                        
                        jqlInput.value = query;
                        jqlInput.focus();
                    });
                });
            });
        </script>
    </th:block>
</body>
</html> 