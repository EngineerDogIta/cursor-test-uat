<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>Dettaglio Job</title>
    <style>
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .log-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .test-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .test-markdown h1, .test-markdown h2, .test-markdown h3 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .test-markdown ul, .test-markdown ol {
            margin-left: 1.5rem;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col">
                <h2>Dettaglio Job</h2>
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Informazioni Job</h5>
                        <p><strong>ID:</strong> <span th:text="${job.id}"></span></p>
                        <p><strong>Ticket Jira:</strong> <span th:text="${job.jiraTicket}"></span></p>
                        <p><strong>Stato:</strong> 
                            <span th:class="${job.status == 'IN_PROGRESS' ? 'badge bg-warning' : 
                                            job.status == 'COMPLETED' ? 'badge bg-success' : 
                                            'badge bg-danger'}"
                                  th:text="${job.status}"></span>
                        </p>
                        <p><strong>Data Creazione:</strong> <span th:text="${#temporals.format(job.createdAt, 'dd/MM/yyyy HH:mm:ss')}"></span></p>
                        <p th:if="${job.completedAt != null}">
                            <strong>Data Completamento:</strong> 
                            <span th:text="${#temporals.format(job.completedAt, 'dd/MM/yyyy HH:mm:ss')}"></span>
                        </p>
                        <p th:if="${job.errorMessage != null}" class="text-danger">
                            <strong>Errore:</strong> <span th:text="${job.errorMessage}"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Colonna sinistra: Log del Job -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Log del Job</h5>
                    </div>
                    <div class="card-body">
                        <div class="log-container">
                            <div th:each="log : ${job.logs}" class="mb-2">
                                <span th:text="${#temporals.format(log.timestamp, 'HH:mm:ss')}"></span>
                                <span th:class="${log.level == 'INFO' ? 'badge bg-info' : 
                                                log.level == 'WARNING' ? 'badge bg-warning' : 
                                                log.level == 'DEBUG' ? 'badge bg-secondary' :
                                                'badge bg-danger'}"
                                      th:text="${log.level}"></span>
                                <span th:text="${log.message}"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Colonna destra: Risultati dei Test -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Risultati dei Test UAT</h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${job.status != 'COMPLETED'}" class="alert alert-info">
                            I risultati dei test UAT saranno disponibili al completamento del job.
                        </div>
                        
                        <div th:if="${job.status == 'COMPLETED' and job.errorMessage == null}" class="test-container">
                            <div class="test-markdown">
                                <!-- Usa il campo testResult del job -->
                                <div th:if="${job.testResult != null}">
                                    <pre th:text="${job.testResult}"></pre>
                                </div>
                                
                                <!-- Se non troviamo testResult, cerchiamo nei log come fallback -->
                                <div th:if="${job.testResult == null}">
                                    <div th:with="testLogs=${job.logs.?[message.contains('Test UAT') || message.contains('SCENARIO:') || message.contains('Generazione dei test completata')]}">
                                        <div th:if="${!testLogs.isEmpty()}">
                                            <!-- Trova il log con il messaggio di generazione completata -->
                                            <div th:with="completedIndex=${testLogs.?[message.contains('Generazione dei test completata')].size() > 0 ? 
                                                                    testLogs.?[message.contains('Generazione dei test completata')].size() - 1 : -1}">
                                                
                                                <!-- Trova il log dei test generati (dovrebbe essere quello precedente o successivo al completato) -->
                                                <div th:if="${completedIndex >= 0 && completedIndex + 1 < testLogs.size()}">
                                                    <pre th:text="${testLogs[completedIndex + 1].message}"></pre>
                                                </div>
                                                
                                                <!-- Se non troviamo il messaggio "completato", cerca qualsiasi log con formato di test -->
                                                <div th:unless="${completedIndex >= 0}">
                                                    <div th:with="testContentLogs=${job.logs.?[message.contains('##') || message.contains('SCENARIO:')]}">
                                                        <div th:if="${!testContentLogs.isEmpty()}">
                                                            <!-- Prendi l'ultimo log che contiene i test -->
                                                            <pre th:text="${testContentLogs[testContentLogs.size() - 1].message}"></pre>
                                                        </div>
                                                        <div th:unless="${!testContentLogs.isEmpty()}" class="alert alert-warning">
                                                            Non sono stati trovati test generati nei log.
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div th:unless="${!testLogs.isEmpty()}" class="alert alert-warning">
                                            Non sono stati trovati test generati nei log.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div th:if="${job.status == 'FAILED'}" class="alert alert-danger">
                            <h6>Errore nella Generazione dei Test</h6>
                            <p th:text="${job.errorMessage}"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="extra-js">
    <script th:if="${job.status == 'IN_PROGRESS'}">
        // Aggiorna automaticamente la pagina ogni 30 secondi se il job Ã¨ in corso
        setTimeout(function() {
            window.location.reload();
        }, 30000);
    </script>
</th:block>
</body>
</html> 