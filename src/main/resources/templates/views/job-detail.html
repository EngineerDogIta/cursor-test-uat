<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>Dettaglio Job</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .log-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .test-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .test-markdown h1, .test-markdown h2, .test-markdown h3 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .test-markdown ul, .test-markdown ol {
            margin-left: 1.5rem;
        }
        .test-markdown pre {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.25rem;
        }
        .test-markdown code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col">
                <h2>Dettaglio Job</h2>
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Informazioni Job</h5>
                        <p><strong>ID:</strong> <span th:text="${job.id}"></span></p>
                        <p><strong>Ticket Jira:</strong> <span th:text="${job.jiraTicket}"></span></p>
                        <p><strong>Stato:</strong> 
                            <span th:class="${job.status == 'IN_PROGRESS' ? 'badge bg-warning' : 
                                            job.status == 'COMPLETED' ? 'badge bg-success' : 
                                            'badge bg-danger'}"
                                  th:text="${job.status}"></span>
                        </p>
                        <p><strong>Data Creazione:</strong> <span th:text="${#temporals.format(job.createdAt, 'dd/MM/yyyy HH:mm:ss')}"></span></p>
                        <p th:if="${job.completedAt != null}">
                            <strong>Data Completamento:</strong> 
                            <span th:text="${#temporals.format(job.completedAt, 'dd/MM/yyyy HH:mm:ss')}"></span>
                        </p>
                        <p th:if="${job.errorMessage != null}" class="text-danger">
                            <strong>Errore:</strong> <span th:text="${job.errorMessage}"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Colonna sinistra: Log del Job -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Log del Job</h5>
                    </div>
                    <div class="card-body">
                        <div class="log-container">
                            <div th:each="log : ${job.logs}" class="mb-2">
                                <span th:text="${#temporals.format(log.timestamp, 'HH:mm:ss')}"></span>
                                <span th:class="${log.level == 'INFO' ? 'badge bg-info' : 
                                                log.level == 'WARNING' ? 'badge bg-warning' : 
                                                log.level == 'DEBUG' ? 'badge bg-secondary' :
                                                'badge bg-danger'}"
                                      th:text="${log.level}"></span>
                                <span th:text="${log.message}"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Colonna destra: Risultati dei Test -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Generated Test UAT</h5>
                    </div>
                    <div class="card-body">
                        <!-- Risultati dei test -->
                        <div class="test-container">
                            <div class="test-markdown">
                                <div th:if="${job.testResult != null and !job.testResult.isEmpty()}" 
                                     id="test-result-content"
                                     th:text="${job.testResult}">
                                </div>
                                <div th:unless="${job.testResult != null and !job.testResult.isEmpty()}" class="alert alert-info">
                                    I risultati dei test UAT non sono ancora disponibili.
                                </div>
                            </div>
                        </div>

                        <!-- Messaggio di errore -->
                        <div th:if="${job.status == 'FAILED'}" class="alert alert-danger">
                            <h6>Errore nella Generazione dei Test</h6>
                            <p th:text="${job.errorMessage}"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="extra-js">
    <script th:if="${job.status != 'FAILED' and job.status != 'COMPLETED'}">
        // Aggiorna automaticamente la pagina ogni 5 secondi se il job non Ã¨ fallito o completato
        setTimeout(function() {
            window.location.reload();
        }, 5000);
    </script>
    <script>
        // Configura marked per il rendering del markdown
        marked.setOptions({
            breaks: true,
            gfm: true
        });
        
        // Converti il contenuto markdown in HTML
        document.addEventListener('DOMContentLoaded', function() {
            const testResultContent = document.getElementById('test-result-content');
            if (testResultContent) {
                const content = testResultContent.textContent;
                testResultContent.innerHTML = marked.parse(content);
            }
        });
    </script>
</th:block>
</body>
</html> 