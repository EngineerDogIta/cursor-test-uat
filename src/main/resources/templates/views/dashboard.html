<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>Dashboard - Test Generation System</title>
    <th:block layout:fragment="extra-css">
        <link th:href="@{/css/dashboard.css}" rel="stylesheet">
    </th:block>
</head>
<body>
    <div layout:fragment="content">
        <div class="row mb-4">
            <div class="col">
                <h2>Dashboard</h2>
                <p class="text-muted">Monitor the status of your test generation jobs</p>
            </div>
            <div class="col text-end">
                <div class="d-flex justify-content-end align-items-center">
                    <div class="view-toggle me-3">
                        <button id="toggle-view" class="btn btn-outline-secondary">
                            <i class="bi bi-list-ul"></i> Compact View
                        </button>
                    </div>
                    <a th:href="@{/ticket-form}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> New Ticket
                    </a>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Colonna sinistra: Jobs in Progress -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Jobs in Progress</h5>
                    </div>
                    <div class="card-body">
                        <!-- Vista Compatta -->
                        <div class="table-responsive" th:if="${isCompactView}">
                            <table class="table table-hover" id="active-jobs-table">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-column="jiraTicket">Jira Ticket<span class="column-tooltip">Click to sort</span></th>
                                        <th class="sortable" data-column="status">Status<span class="column-tooltip">Click to sort</span></th>
                                        <th class="sortable" data-column="createdAt">Creation Date<span class="column-tooltip">Click to sort</span></th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="job : ${activeJobs}">
                                        <td th:text="${job.jiraTicket}" th:data-value="${job.jiraTicket}"></td>
                                        <td th:data-value="${job.status}">
                                            <span th:class="${job.status == T(com.example.model.TestGenerationJob.JobStatus).IN_PROGRESS ? 'badge bg-warning text-dark status-badge' : 
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).COMPLETED ? 'badge bg-success text-white status-badge' : 
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).FAILED ? 'badge bg-danger text-white status-badge' :
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).PENDING ? 'badge bg-secondary text-white status-badge' :
                                                   'badge bg-info text-white status-badge'}">
                                                <i th:class="${job.status == T(com.example.model.TestGenerationJob.JobStatus).IN_PROGRESS ? 'bi bi-arrow-repeat status-icon spin' : 
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).COMPLETED ? 'bi bi-check-circle status-icon' : 
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).FAILED ? 'bi bi-x-circle status-icon' :
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).PENDING ? 'bi bi-hourglass status-icon' :
                                                   'bi bi-question-circle status-icon'}"></i>
                                                <span th:text="${job.status}"></span>
                                            </span>
                                        </td>
                                        <td th:text="${#temporals.format(job.createdAt, 'dd/MM/yyyy HH:mm')}" th:data-value="${job.createdAt}"></td>
                                        <td>
                                            <div class="btn-group">
                                                <a th:href="@{/job/{id}(id=${job.id})}" class="btn btn-sm btn-info me-1">
                                                    <i class="bi bi-eye"></i> Dettagli
                                                </a>
                                                <button th:if="${job.status != T(com.example.model.TestGenerationJob.JobStatus).IN_PROGRESS}"
                                                        class="btn btn-sm btn-danger delete-job-btn" 
                                                        th:data-job-id="${job.id}"
                                                        th:data-ticket-id="${job.jiraTicket}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Vista Standard (Carte) -->
                        <div class="card-grid-container" th:unless="${isCompactView}">
                            <div class="card-grid">
                                <div class="job-card" th:each="job : ${activeJobs}">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0" th:text="${job.jiraTicket}"></h6>
                                            <span th:class="${job.status == T(com.example.model.TestGenerationJob.JobStatus).IN_PROGRESS ? 'badge bg-warning text-dark status-badge' : 
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).COMPLETED ? 'badge bg-success text-white status-badge' : 
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).FAILED ? 'badge bg-danger text-white status-badge' :
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).PENDING ? 'badge bg-secondary text-white status-badge' :
                                                   'badge bg-info text-white status-badge'}">
                                                <i th:class="${job.status == T(com.example.model.TestGenerationJob.JobStatus).IN_PROGRESS ? 'bi bi-arrow-repeat status-icon spin' : 
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).COMPLETED ? 'bi bi-check-circle status-icon' : 
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).FAILED ? 'bi bi-x-circle status-icon' :
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).PENDING ? 'bi bi-hourglass status-icon' :
                                                   'bi bi-question-circle status-icon'}"></i>
                                                <span th:text="${job.status}"></span>
                                            </span>
                                        </div>
                                        <div class="card-body">
                                            <div class="ticket-preview">
                                                <p class="ticket-description" th:text="${job.description}"></p>
                                                <div class="ticket-meta">
                                                    <small class="text-muted">
                                                        <i class="bi bi-clock"></i>
                                                        <span th:text="${#temporals.format(job.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="action-buttons mt-3">
                                                <a th:href="@{/job/{id}(id=${job.id})}" class="btn btn-sm btn-info">
                                                    <i class="bi bi-eye"></i> Dettagli
                                                </a>
                                                <button th:if="${job.status != T(com.example.model.TestGenerationJob.JobStatus).IN_PROGRESS}"
                                                        class="btn btn-sm btn-danger delete-job-btn"
                                                        th:data-job-id="${job.id}"
                                                        th:data-ticket-id="${job.jiraTicket}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Colonna destra: Completed Jobs -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Completed Jobs</h5>
                    </div>
                    <div class="card-body">
                        <!-- Vista Compatta -->
                        <div class="table-responsive" th:if="${isCompactView}">
                            <table class="table table-hover" id="completed-jobs-table">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-column="jiraTicket">Jira Ticket<span class="column-tooltip">Click to sort</span></th>
                                        <th class="sortable" data-column="status">Status<span class="column-tooltip">Click to sort</span></th>
                                        <th class="sortable" data-column="completedAt">Completion Date<span class="column-tooltip">Click to sort</span></th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="job : ${completedJobs}">
                                        <td th:text="${job.jiraTicket}" th:data-value="${job.jiraTicket}"></td>
                                        <td th:data-value="${job.status}">
                                            <span th:class="${job.status == T(com.example.model.TestGenerationJob.JobStatus).IN_PROGRESS ? 'badge bg-warning text-dark status-badge' : 
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).COMPLETED ? 'badge bg-success text-white status-badge' : 
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).FAILED ? 'badge bg-danger text-white status-badge' :
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).PENDING ? 'badge bg-secondary text-white status-badge' :
                                                   'badge bg-info text-white status-badge'}">
                                                <i th:class="${job.status == T(com.example.model.TestGenerationJob.JobStatus).IN_PROGRESS ? 'bi bi-arrow-repeat status-icon spin' : 
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).COMPLETED ? 'bi bi-check-circle status-icon' : 
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).FAILED ? 'bi bi-x-circle status-icon' :
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).PENDING ? 'bi bi-hourglass status-icon' :
                                                   'bi bi-question-circle status-icon'}"></i>
                                                <span th:text="${job.status}"></span>
                                            </span>
                                        </td>
                                        <td th:text="${#temporals.format(job.completedAt, 'dd/MM/yyyy HH:mm')}" th:data-value="${job.completedAt}"></td>
                                        <td>
                                            <div class="btn-group">
                                                <a th:href="@{/job/{id}(id=${job.id})}" class="btn btn-sm btn-info me-1">
                                                    <i class="bi bi-eye"></i> Dettagli
                                                </a>
                                                <button th:if="${job.status != T(com.example.model.TestGenerationJob.JobStatus).IN_PROGRESS}"
                                                        class="btn btn-sm btn-danger delete-job-btn" 
                                                        th:data-job-id="${job.id}"
                                                        th:data-ticket-id="${job.jiraTicket}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Vista Standard (Carte) -->
                        <div class="card-grid-container" th:unless="${isCompactView}">
                            <div class="card-grid">
                                <div class="job-card" th:each="job : ${completedJobs}">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0" th:text="${job.jiraTicket}"></h6>
                                            <span th:class="${job.status == T(com.example.model.TestGenerationJob.JobStatus).IN_PROGRESS ? 'badge bg-warning text-dark status-badge' : 
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).COMPLETED ? 'badge bg-success text-white status-badge' : 
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).FAILED ? 'badge bg-danger text-white status-badge' :
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).PENDING ? 'badge bg-secondary text-white status-badge' :
                                                   'badge bg-info text-white status-badge'}">
                                                <i th:class="${job.status == T(com.example.model.TestGenerationJob.JobStatus).IN_PROGRESS ? 'bi bi-arrow-repeat status-icon spin' : 
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).COMPLETED ? 'bi bi-check-circle status-icon' : 
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).FAILED ? 'bi bi-x-circle status-icon' :
                                                   job.status == T(com.example.model.TestGenerationJob.JobStatus).PENDING ? 'bi bi-hourglass status-icon' :
                                                   'bi bi-question-circle status-icon'}"></i>
                                                <span th:text="${job.status}"></span>
                                            </span>
                                        </div>
                                        <div class="card-body">
                                            <div class="ticket-preview">
                                                <p class="ticket-description" th:text="${job.description}"></p>
                                                <div class="ticket-meta">
                                                    <small class="text-muted">
                                                        <i class="bi bi-clock"></i>
                                                        <span th:text="${#temporals.format(job.completedAt, 'dd/MM/yyyy HH:mm')}"></span>
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="action-buttons mt-3">
                                                <a th:href="@{/job/{id}(id=${job.id})}" class="btn btn-sm btn-info">
                                                    <i class="bi bi-eye"></i> Dettagli
                                                </a>
                                                <button th:if="${job.status != T(com.example.model.TestGenerationJob.JobStatus).IN_PROGRESS}"
                                                        class="btn btn-sm btn-danger delete-job-btn"
                                                        th:data-job-id="${job.id}"
                                                        th:data-ticket-id="${job.jiraTicket}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="extra-js">
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Implementazione dell'ordinamento delle colonne
                const sortableColumns = document.querySelectorAll('th.sortable');
                
                sortableColumns.forEach(column => {
                    column.addEventListener('click', function() {
                        const tableId = this.closest('table').id;
                        const tableRows = document.querySelectorAll(`#${tableId} tbody tr`);
                        const columnName = this.dataset.column;
                        const isAsc = this.classList.contains('asc');
                        
                        // Rimuovi classi di ordinamento esistenti
                        document.querySelectorAll(`#${tableId} th.sortable`).forEach(el => {
                            el.classList.remove('asc', 'desc');
                        });
                        
                        // Aggiungi classe di ordinamento attuale
                        this.classList.add(isAsc ? 'desc' : 'asc');
                        
                        // Converti le righe in array per ordinamento
                        const rowsArray = Array.from(tableRows);
                        
                        // Ordinamento
                        rowsArray.sort((a, b) => {
                            const aValue = a.querySelector(`td[data-value="${columnName}"]`) 
                                ? a.querySelector(`td[data-value="${columnName}"]`).dataset.value 
                                : a.children[Array.from(this.parentNode.children).indexOf(this)].textContent.trim();
                                
                            const bValue = b.querySelector(`td[data-value="${columnName}"]`) 
                                ? b.querySelector(`td[data-value="${columnName}"]`).dataset.value 
                                : b.children[Array.from(this.parentNode.children).indexOf(this)].textContent.trim();
                                
                            // Determinare il tipo di dati
                            if (!isNaN(aValue) && !isNaN(bValue)) {
                                return isAsc ? bValue - aValue : aValue - bValue;
                            } else {
                                return isAsc ? bValue.localeCompare(aValue) : aValue.localeCompare(bValue);
                            }
                        });
                        
                        // Riattacca le righe nella tabella
                        const tbody = document.querySelector(`#${tableId} tbody`);
                        rowsArray.forEach(row => tbody.appendChild(row));
                        
                        // Salva lo stato di ordinamento
                        localStorage.setItem(`${tableId}-sort-column`, columnName);
                        localStorage.setItem(`${tableId}-sort-direction`, isAsc ? 'desc' : 'asc');
                    });
                });
                
                // Ripristina lo stato di ordinamento al caricamento
                ['active-jobs-table', 'completed-jobs-table'].forEach(tableId => {
                    const savedColumn = localStorage.getItem(`${tableId}-sort-column`);
                    const savedDirection = localStorage.getItem(`${tableId}-sort-direction`);
                    
                    if (savedColumn && savedDirection) {
                        const columnHeader = document.querySelector(`#${tableId} th[data-column="${savedColumn}"]`);
                        if (columnHeader) {
                            columnHeader.classList.add(savedDirection);
                            
                            // Simula un click per ordinare
                            if (savedDirection === 'desc') {
                                columnHeader.classList.add('asc');
                            }
                            columnHeader.click();
                        }
                    }
                });
                
                // Toggle per la visualizzazione compatta
                const toggleViewBtn = document.getElementById('toggle-view');

                toggleViewBtn.addEventListener('click', function() {
                    fetch('/toggle-view')
                        .then(response => response.json())
                        .then(data => {
                            // Ricarica la pagina per applicare la nuova vista
                            window.location.reload();
                        })
                        .catch(error => console.error('Error:', error));
                });
                
                // Imposta il testo corretto del pulsante in base allo stato attuale
                const isCompactView = /*[[${isCompactView}]]*/ false;
                if (isCompactView) {
                    toggleViewBtn.innerHTML = '<i class="bi bi-list"></i> Vista standard';
                } else {
                    toggleViewBtn.innerHTML = '<i class="bi bi-grid"></i> Vista compatta';
                }
                
                // Animazione di rotazione per icone di jobs in progress
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes spin {
                        from { transform: rotate(0deg); }
                        to { transform: rotate(360deg); }
                    }
                    .spin {
                        animation: spin 2s linear infinite;
                    }
                `;
                document.head.appendChild(style);
            });
        </script>
    </th:block>
</body>
</html> 